<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoE Management Platform</title>
    <link rel="stylesheet" href="assets/css/styles.css">


    <!-- Firebase v9 Modular SDK -->
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, connectFirestoreEmulator } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { firebaseConfig } from "./firebase-config.js";
        
        // Fallback: create config from window.ENV if import fails
        const config = firebaseConfig || {
            apiKey: window.ENV?.FIREBASE_API_KEY || 'N/A',
            authDomain: window.ENV?.FIREBASE_AUTH_DOMAIN || 'N/A',
            projectId: window.ENV?.FIREBASE_PROJECT_ID || 'N/A',
            storageBucket: window.ENV?.FIREBASE_STORAGE_BUCKET || 'N/A',
            messagingSenderId: window.ENV?.FIREBASE_MESSAGING_SENDER_ID || 'N/A',
            appId: window.ENV?.FIREBASE_APP_ID || 'N/A'
        };
        
        try {
            console.log('Starting Firebase initialization...');
            
            // Initialize Firebase
            const app = initializeApp(config);
            console.log('Firebase app initialized');
            
            // Initialize Firestore with specific database ID
            const db = getFirestore(app, 'historical-employee-data');
            console.log('Firestore initialized with historical-employee-data');
            
            // Make available globally
            window.firebaseApp = app;
            window.db = db;
            window.firebaseConfig = config; // Use the config object
            
            // Import Firestore functions and make them global for views
            console.log('Loading Firestore module...');
            const firestoreModule = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            window.firestoreModule = firestoreModule;
            console.log('Firestore module loaded');
            
            // Small delay to ensure everything is ready
            setTimeout(() => {
                // Verify all components are ready before dispatching
                if (window.db && window.firestoreModule && window.firebaseApp) {
                    console.log('All Firebase components ready, dispatching event...');
                    // Dispatch ready event
                    window.dispatchEvent(new CustomEvent('firebaseReady', {
                        detail: { app, db, firestoreModule, ready: true }
                    }));
                    
                    // Manual fallback for Member Directory if view script doesn't execute
                    setTimeout(() => {
                        if (window.location.hash === '#member-directory' && !window.memberDirectory) {
                            if (window.MemberDirectory) {
                                try {
                                    window.memberDirectory = new window.MemberDirectory();
                                } catch (error) {
                                    console.error('Failed to create MemberDirectory:', error);
                                }
                            }
                        }
                    }, 2000);
                } else {
                    console.error('Firebase components not all ready:', {
                        db: !!window.db,
                        firestoreModule: !!window.firestoreModule,
                        firebaseApp: !!window.firebaseApp
                    });
                    // Dispatch error event
                    window.dispatchEvent(new CustomEvent('firebaseReady', {
                        detail: { error: 'Firebase components not ready', ready: false }
                    }));
                }
            }, 1000); // Increased delay to 1 second
            
        } catch (error) {
            console.error('Firebase initialization failed:', error);
            window.firebaseInitFailed = true;
            
            // Dispatch error event
            window.dispatchEvent(new CustomEvent('firebaseReady', {
                detail: { error: error.message }
            }));
        }
    </script>
    
    <!-- Load other scripts after Firebase -->
    <script src="js/utils/viewLoader.js"></script>
    <script src="js/components/navigation.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Persistent Left-Hand Navigation Sidebar -->
        <aside class="sidebar">
            <div class="logo">CoE Management</div>
            <nav>
                <ul>
                    <li><a href="#dashboard" class="nav-link active">Dashboard</a></li>
                    <li><a href="#resource-planner" class="nav-link">Resource Planner</a></li>
                    <li><a href="#member-directory" class="nav-link">Member Directory</a></li>
                    <li><a href="#projects" class="nav-link">Projects</a></li>
                    <li class="submenu">
                        <a href="#settings" class="nav-link">Settings (Admin only)</a>
                        <ul>
                            <li><a href="#settings-data-import" class="nav-link">Data Import</a></li>
                            <li><a href="#settings-key-members" class="nav-link">Key Members</a></li>
                            <li><a href="#settings-notifications" class="nav-link">Notifications</a></li>
                        </ul>
                    </li>
                </ul>
            </nav>
        </aside>
        <div class="main-container">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="user-menu">
                    <div class="notifications">[Notifications Icon]</div>
                    <div class="user-name">[User Name v]</div>
                </div>
            </header>
            <!-- Main Content Area -->
            <main class="main-content">
                <div id="view-container">
                    <!-- Views will be loaded here -->
                </div>
            </main>
        </div>
    </div>
    <div id="ai-chat-icon">
        <!-- AI Assistant Icon -->
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="white">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10c5.52 0 10-4.48 10-10S17.51 2 11.99 2zM12 20c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5.5-4.5l2.75 1.1V8.4l-2.75 1.1zM16.5 9.5l-2.75-1.1v8.2l2.75-1.1z"/>
        </svg>
    </div>
    
    <!-- Scripts -->
    <script>
        // Additional initialization if needed
        console.log('Main page loaded');
    </script>
</body>
</html>